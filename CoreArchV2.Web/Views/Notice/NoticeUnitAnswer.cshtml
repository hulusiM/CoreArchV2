@using CoreArchV2.Core.Enum.NoticeVehicle.Notice
<script>$('#broadCrumbDiv').text('Talep Yönetimi / Birim Cevap İşlemleri')</script>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div id="reportNoticeDiv" class="row" style="margin: 3px -20px 0 -29px; display: none;">
    <div class="col-sm-6 col-md-3">
        <div class="panel panel-body" title="Açık/Toplam Taleplerim">
            <div class="media no-margin">
                <div class="media-body">
                    <h5 class="no-margin text-semibold">2/10 Adet</h5>
                    <span class="text-uppercase text-size-mini text-muted">Taleplerim</span>
                </div>

                <div class="media-right media-middle">
                    <i class=" icon-git-pull-request icon-3x text-danger-400"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-md-3">
        <div class="panel panel-body panel-body-accent">
            <div class="media no-margin">
                <div class="media-left media-middle">
                    <i class="icon-pointer icon-3x text-success-400"></i>
                </div>

                <div class="media-body text-right">
                    <h5 class="no-margin text-semibold">7 Adet</h5>
                    <span class="text-uppercase text-size-mini text-muted">Açık Talep</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-md-3">
        <div class="panel panel-body">
            <div class="media no-margin">
                <div class="media-left media-middle">
                    <i class="icon-enter6 icon-3x text-indigo-400"></i>
                </div>

                <div class="media-body text-right">
                    <h5 class="no-margin text-semibold">5 Adet</h5>
                    <span class="text-uppercase text-size-mini text-muted">Kapalı Talep</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-md-3">
        <div class="panel panel-body">
            <div class="media no-margin">
                <div class="media-body">
                    <h5 class="no-margin text-semibold">12 Adet</h5>
                    <span class="text-uppercase text-size-mini text-muted">Toplam Talep</span>
                </div>

                <div class="media-right media-middle">
                    <i class="icon-bubbles4 icon-3x text-blue-400"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="breadcrumb-line breadcrumb-line-component content-group-lg bg-teal-400" style="margin: 3px -11px 0 -23px;">
    <ul class="breadcrumb">
        <li>Birim Talep Cevap İşlemleri</li>
    </ul>

    <ul class="breadcrumb-elements">
        <li>
            <a onclick="reportNotice()"><i class="icon-chart position-left"></i> Talep Rapor</a>
        </li>
        <li class="dropdown">
            <a href="#" id="btnSearch" class="dropdown-toggle" data-toggle="dropdown" onclick="funcSearchForm()">
                <i class="icon-gear position-left"></i>
                Filtreleme Seçenekleri
                <span class="caret"></span>
            </a>
            <ul id="FormSearchTable" class="dropdown-menu dropdown-menu-right">
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <label>İhbar Tipi :</label>
                        <select id="comboBox-NoticeTypeId-search"
                                class="select-search"
                                tabindex="1"
                                table-param="NoticeTypeId"
                                table-id="comboBox-NoticeTypeId-search"
                                table-model-url="/Combo/GetNoticeType"
                                table-tool-type="comboBox"
                                table-description="İhbar Tipi"
                                data-option-label="İhbar Tipi Seçiniz">
                        </select>
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <button type="button" style="width: 100%;" class="btn bg-danger-800 btn-xs" onclick="funcClearFilterTable('FormSearchTable')"><i class="icon-trash"></i> Temizle</button>
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin: 8px 0 8px 0;">
                        <button type="button" style="float: left; width: 100%;" class="btn bg-teal-300 btn-xs" onclick="funcFilterTable()"><i class="icon-search4"></i> Filtrele</button>
                    </div>
                </li>
            </ul>
        </li>
    </ul>
</div>

<div class="content has-bg-image small" style="margin: -25px -10px 0px -23px;">
    <div class="panel panel-flat has-bg-image">
        <div class="panel-body ">
            <div class="row">
                <div class="table-responsive genericDatatables">
                    <table class="table-striped table-hover table-bordered table datatable-basic table-loader"
                           id="dataTableNotice"
                           table-id="dataTable-Notice"
                           table-model-url="/Notice/NoticeUnitAnswerGetAll"
                           table-DatabaseName="/Notice"
                           table-tool-type="dataTable">
                        <thead>
                            <tr class="filters">
                                <th data-value="Id" hidden="hidden"></th>
                                <th style="text-align: center; width: 1%;">No</th>
                                <th data-value="Id" style="text-align: center;">
                                    Talep No
                                </th>
                                <th data-value="OpenDate" data-type="datetime" style="text-align: center;">
                                    Talep Aç. Tarihi
                                </th>
                                <th data-value="ClosedDate" data-type="datetime" style="text-align: center;">
                                    Talep Kap. Tarihi
                                </th>
                                <th data-value="NoticeTypeName" style="text-align: center;">
                                    Talep Tipi
                                </th>
                                <th data-value="NoticeUnitTypeName" style="text-align: center;">
                                    Talep Türü
                                </th>
                                <th data-value="StateName" style="text-align: center;">
                                    Talep Durum
                                </th>
                                <th data-value="ButtonEditDelete" style="text-align: center;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="table-footer">
                    <div class="col-md-12" id="TableFooter">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="NoticeAnswerModal" class="modal fade" data-backdrop="static">
    <div class="modal-dialog modal-full">
        <div class="modal-content">
            <div class="modal-header bg-primary-300">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h6 class="modal-title">Birim Talep Bilgileri</h6>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tabbable tab-content-bordered">
                            <ul class="nav nav-tabs nav-tabs-highlight nav-justified">
                                <li id="liAttr_1" class="active">
                                    <a id="NoticeUnitAnswer_toggle" href="#noticeUnit_Answer" data-toggle="tab"><i class="icon-redo2 position-left "></i>Talep Bilgileri</a>
                                </li>
                                <li id="liAttr_2">
                                    <a id="NoticeUnitHistory_toggle" href="#noticeUnit_History" data-toggle="tab"><i class="icon-history position-left "></i>Talep Geçmişi</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <input id="noticeUnitAnswerNoticeUnitId" type="text" table-param="Id" hidden />
                                <input id="noticeUnitAnswerType" type="text" table-param="noticeUnitAnswerType" hidden />
                                <div class="tab-pane has-padding active" id="noticeUnit_Answer">
                                    @await Html.PartialAsync("~/Views/Shared/PartialViews/VehicleNotice/NoticeUnitAnswer/_NoticeUnitAns.cshtml")
                                </div>
                                <div class="tab-pane has-padding" id="noticeUnit_History">
                                    @await Html.PartialAsync("~/Views/Shared/PartialViews/VehicleNotice/NoticeUnit/_NoticeUnitHistory.cshtml")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("~/Views/Shared/PartialViews/VehicleNotice/NoticeUnit/_NoticeUnitHistoryDetail.cshtml")
<script src="~/js/jsutilities/fileuploader_notice.js"></script>
<script>
       function previewNotice(noticeUnitId,redirectType) {
           $('#noticeUnitAnswerNoticeUnitId').val(noticeUnitId);
           $('#noticeUnitAnswerType').val(redirectType);
           $('#NoticeUnitAnswer_toggle').click();
           $('#NoticeAnswerModal').modal("show");
       }

       function loadNoticeUnitAnswer(noticeUnitId,redirectType) {
           $('#noticeUnitAnsList_').load("/Notice/GetNoticeUnitAnswerList",
               {
                   noticeUnitId: noticeUnitId,
                   redirectType:redirectType
               });
       }

       $('#NoticeUnitAnswer_toggle').click(function () {
           loadNoticeUnitAnswer($('#noticeUnitAnswerNoticeUnitId').val(),$('#noticeUnitAnswerType').val());
       });

       $('#NoticeUnitHistory_toggle').click(function () {
           var noticeUnitId = $('#noticeUnitAnswerNoticeUnitId').val();
           $('#noticeHistoryUlLi').load("/Notice/GetNoticeUnitHistory",
               {
                    id: noticeUnitId,
                    partialPath : 'PartialViews/VehicleNotice/NoticeUnit/_NoticeUnitHistory'
               });
       });

       function insertNoticeUnitAnswer() {
           var noticeUnitId = $('#noticeUnitAnswerNoticeUnitId').val();
           var descripton = $('#noticeUnitAnswerDesc').summernote('code');

           $("#excelPrew_true tr [table-param]").css("background-color", "white");
           var arr = $("#noticeUnitAnsList_ #excelPrew_true tr");
           var model = {
               Id: noticeUnitId,
               Amount: '',
               DriverId: '',
               RedirectType: $('#noticeUnitAnswerType').val(),
               Description: (descripton == "<p><br></p>" ? "" : descripton),
               NoticeList:[]
           };

           for (var i = 0; i < arr.length; i++) {
               var md = FormGetAllValue("#" + arr[i].id + " [table-param]");
               if (parseInt(md.State) == 0 || md.Description.replace(/(<([^>]+)>)/ig,"") == "") {
                   $("#" + arr[i].id + ' [table-param]').css("background-color", "orange");
                   ShowMessage("info", "Bilgi", "Zorunlu alanlar boş geçilemez");
                   return;
               }else if (md.State != @((int)NoticePunishmentState.PayCut) && (parseInt(md.Amount) > 0)) {
                   $("#" + arr[i].id + ' [table-param]').css("background-color", "orange");
                   ShowMessage("info", "Bilgi", "Ceza tutarı alanı sadece <b>ücret kesintisi</b> tipinde girilmelidir",10000);
                   return;
               }
               else {
                   var tempModel = {
                       Id: md.Id,
                       State: md.State,
                       Description: md.Description
                   };
                   model.NoticeList.push(tempModel);
               }
           }

           sendAjxForm(model, "/Notice/InsertNoticeUnitAnswer",
               function (e) {
                   if (e.IsSuccess) {
                       ShowMessage("success", "Bilgi", "İşlem başarılı");
                       $('#NoticeUnitAnswer_toggle').click();
                   } else
                       ShowMessage("info", "Bilgi", e.Message);
               }, 'POST');
       }

       function changeUnitRedirectType(event,isWarning=false) {
           if (isWarning) {
                $('#excelPrew_true tr [table-param]').css('background-color', 'white');
               var id = '#amount_' + event.id.split('_')[1];
               if (event.value != @((int) NoticePunishmentState.PayCut))
                   $(id).prop("disabled", true).val('');
               else
                   $(id).prop("disabled", false);
           }
       }

       function changeInputSetWidth(id) {
           //var toggleWidth = "0px";
           //if($("#description_"+id).width() != 500)
           //{
           //    toggleWidth="500px";
           //}
           //else
           //{
           //    toggleWidth="96px";
           //}
           //$("#description_"+id).animate({ width: toggleWidth });
       }

       $(document).mouseup(function(e) {
           //$('.moneyDisabled').prop("disabled", true);
           $('body [table-param="Description"]').animate({ width: "350px" });
       });
</script>

