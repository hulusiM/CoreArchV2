@using CoreArchV2.Core.Enum
<div id="VehicleAmount_FormId">
    <div class="form-group">
        <div class="row">
            <div class="col-md-3">
                <label>Tutar Tipi (*) :</label>
                <select id="VehicleAmountTypeId"
                        class="select-search"
                        table-param="TypeId"
                        table-id="comboBox-VehicleAmountTypeId"
                        table-model-url="/Combo/GetContractAmountType?fixtureTypeId=@((int) FixtureType.ForRent)"
                        table-tool-type="comboBox"
                        tabindex="2"
                        table-description="Tutar Tipi"
                        data-option-label="Tutar Tipi Seçiniz" required>
                </select>
            </div>
            <div class="col-md-3">
                <label>Tarih (*) :</label>
                <input id="AmountDate" table-param="StartDate" tabindex="1" type="date" class="form-control" table-description="Tarih" autocomplete="off" required>
            </div>
            <div class="col-md-3">
                <label>Gider (*) :</label>
                <input id="VehicleAmount" table-param="Amount" tabindex="3" type="text" class="form-control moneyCurrency" table-description="Gider" autocomplete="off" placeholder="Gider giriniz" required>
            </div>
            <div class="col-md-3">
                <label>Gelir :</label>
                <input id="VehicleAmountIncome" table-param="AmountIncome" tabindex="3" type="text" class="form-control moneyCurrency" autocomplete="off" placeholder="Gelir giriniz">
            </div>
        </div>
    </div>

    <div class="form-group">
        <div class="row">
            <div class="col-md-12">
                <label class="control-label">Açıklama</label>
                <textarea rows="2" cols="5" table-param="Description" tabindex="4" class="form-control" placeholder="Açıklama"></textarea>
            </div>
        </div>
    </div>
</div>

<div class="form-group vehicleActionButtons">
    <div class="row">
        <div class="col-md-6"></div>
        <div class="col-md-3">
            <button type="button" tabindex="6" class="btn btn-danger full-width" onclick="$('#VehicleAmountModal').modal('hide')"><i class="fa fa-times"></i> İptal</button>
        </div>
        <div class="col-md-3">
            <button onclick="SaveVehicleAmount()" tabindex="5" type="button" class="btn btn-default btn-success full-width"><i class="icon-make-group position-left"></i> Kaydet</button>
        </div>
    </div>
</div>
<div class="panel">
    <div class="panel-heading bg-pink-300">
        <h6 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion-controls" href="#accordion-controls-group-last" id="currentContractDateHead">Güncel Dönem Detay</a>
        </h6>
    </div>
    <div id="accordion-controls-group-last" class="panel-collapse collapse in">
        <div class="panel-body">
            <div class="form-group">
                <div class="row">
                    <div class="panel panel-body border-top-teal" style="height: 350px; overflow: scroll;">
                        <select id="VehicleAmountTypeId2"
                                class="select-search"
                                table-param="TypeId"
                                table-id="comboBox-VehicleAmountTypeId2"
                                table-model-url="/Combo/GetContractAmountType?fixtureTypeId=@((int) FixtureType.ForRent)"
                                table-tool-type="comboBox"
                                onchange="changeAmount()"
                                table-description="Tutar Tipi"
                                data-option-label="Tutar Tipi Seçiniz">
                        </select>
                        <table class="table-striped table-hover table-bordered table datatable-basic">
                            <thead>
                                <tr>
                                    <th style="text-align: center;">Tutar Tipi</th>
                                    <th style="text-align: center;">Söz. Tar.</th>
                                    <th style="text-align: center;">Açıklama</th>
                                    <th style="text-align: center;">Gider (Aylık)</th>
                                    <th style="text-align: center;">Gelir (Aylık)</th>
                                    <th style="text-align: center;">Güncel Gider <i title="Bugüne kadar toplam gider" class="icon-info22 position-left text-danger faa-flash animated"></i></th>
                                    <th style="text-align: center;">Güncel Gelir <i title="Bugüne kadar toplam gelir" class="icon-info22 position-left text-danger faa-flash animated"></i></th>
                                    <th style="text-align: center;">Toplam Gider</th>
                                    <th style="text-align: center;">Toplam Gelir</th>
                                    <th style="text-align: center;"></th>
                                </tr>
                            </thead>
                            <tbody id="vehicleAmountHistoryTableForRent">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    function getHistoryAmountRent(amountTypeId = 0) {
        var model = {};
        var vehicleId = $('#vehicle_Id').val();
        if (amountTypeId > 0)
            model = { vehicleId: vehicleId, vehicleAmountTypeId: amountTypeId };
        else
            model = { vehicleId: vehicleId };

        sendAjxForm(model,
            "/Vehicle/GetByVehicleIdVehicleAmountHistory",
            function (data) {
                if (data != null) {
                    $('#vehicleAmountHistoryTableForRent tr').remove();
                    var result = "";
                    var e = data.VehicleAmountList;
                    for (var i = 0; i < e.length; i++) {
                        result += "<tr style='text-align: center;'><td>" +
                            "<span class='label bg-success-300 full-width'>" +
                            e[i].VehicleAmountTypeName +
                            "</span></td>" +
                            "<td>" +
                            ConvertJSONJustDateFormatISO(e[i].StartDate) + " - " + ConvertJSONJustDateFormatISO(e[i].EndDate) + "<br/>" + (e[i].DeleteVehicleInfo ?? '') +
                            "</td>" +
                            "<td>" +
                            (e[i].Description != null ? e[i].Description : '') +
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].AmountExpense, 2) + " ₺" + //Gider
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].AmountIncome, 2) + " ₺" + //Gelir
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].TotalTodayExpense, 2) + " ₺" + //Güncel Gider
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].TotalTodayIncome, 2) + " ₺" + //Güncel Gelir
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].AllTotalExpense, 2) + " ₺" + //Top. Gider
                            "</td>" +
                            "<td class='text-right'>" +
                            formatMoney(e[i].AllTotalIncome, 2) + " ₺" + //Top. Gelir
                            "</td>" +
                            "<td class='text-right'>" +
                            e[i].CustomButton +
                            " </td></tr>";
                    }
                    result += "<tr>";
                    result += "<td class='text-right' colspan='4'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcExpense(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='1'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcIncome(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='1'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcTotalExpense(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='1'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcTotalIncome(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='1'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcAllTotalExpense(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='1'><span class='label bg-orange-300'><b style='color:black;'>= " + formatMoney(calcAllTotalIncome(e)) + " ₺</b></span></td></tr>";

                    result += "<tr>";
                    result += "<td class='text-right' colspan='7'><span class='label bg-success-300'><b style='color:black;'>Fark Güncel Toplam : " + formatMoney(calcTotalIncome(e) - calcTotalExpense(e)) + " ₺</b></span></td>";
                    result += "<td class='text-right' colspan='2'><span class='label bg-success-300'><b style='color:black;'>Fark Genel Toplam : " + formatMoney(calcAllTotalIncome(e) - calcAllTotalExpense(e)) + " ₺</b></span></td></tr>";

                    $('#vehicleAmountHistoryTableForRent').append(result);
                    $('#currentContractDateHead').html("Güncel Dönem Detay - (" + ConvertJSONJustDateFormatISONoBackgroundColor(data.StartDate) + " / " + ConvertJSONJustDateFormatISONoBackgroundColor(data.EndDate) + ")");
                } else
                    ShowMessage("info", "Bilgi", "Geçmiş kayıt bulunamadı");
            },
            'GET');
    }

    function changeAmount() {
        getHistoryAmountRent($('#VehicleAmountTypeId2').val());
    }

    function calcExpense(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].AmountExpense);
        return toplam;
    }

    function calcIncome(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].AmountIncome);
        return toplam;
    }

    function calcTotalExpense(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].TotalTodayExpense);
        return toplam;
    }

    function calcTotalIncome(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].TotalTodayIncome);
        return toplam;
    }

    function calcAllTotalExpense(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].AllTotalExpense);
        return toplam;
    }

    function calcAllTotalIncome(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].AllTotalIncome);
        return toplam;
    }



    function totalAmount(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].TotalAmount);
        return toplam;
    }

    function totalAmount2(data) {
        var toplam = 0;
        for (var i = 0; i < data.length; i++)
            toplam += parseFloat(data[i].TotalAmount2);
        return toplam;
    }

    function SaveVehicleAmount() {
        var model = FormGetAllValue("#VehicleAmount_FormId [table-param]");
        if (model != null) {
            var mergeObject = $.extend(model, { VehicleId: $('#vehicle_Id').val() });
            sendAjxForm(mergeObject,
                "/Vehicle/InsertVehicleAmount",
                function (e) {
                    if (e.IsSuccess == true) {
                        FormAllInputsClearNoCloseModal("#VehicleAmount_FormId [table-param]");
                        getHistoryAmountRent();
                        ShowMessage("success", "Bilgi", "Kayıt Başarılı");
                    } else if (!e.IsSuccess)
                        ShowMessage("info", "Bilgi", e.Message);

                },
                'POST');
        }
    }

    function funcDeleteVehicleAmount(vehicleContractId, vehicleAmountId) {
        var model = {
            vehicleContractId: vehicleContractId,
            vehicleAmountId: vehicleAmountId
        };
        swal({
            title: "Emin misiniz?",
            text: "Bu kayıt silinecektir !",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#EF5350",
            confirmButtonText: "Evet, Kaydı Sil!",
            cancelButtonText: "Hayır, Kayıt Kalsın!",
            closeOnConfirm: false,
            closeOnCancel: false
        }, function (isConfirm) {
            if (isConfirm) {
                sendAjxForm(model,
                    "/Vehicle/DeleteVehicleAmount",
                    function (e) {
                        if (e.IsSuccess == true) {
                            swal({
                                title: "Başarılı!",
                                text: "Kayıt silindi.",
                                confirmButtonColor: "#66BB6A",
                                type: "success"
                            });
                            getHistoryAmountRent();
                            ShowMessage("success", "Bilgi", "Silme Başarılı.");
                        } else {
                            $(".cancel").click();
                            $(".confirm").click();
                            ShowMessage("warning", "Bilgi", e.Message);
                        }
                    },
                    "POST");
            } else {
                swal({
                    title: "İsteğiniz üzere iptal Edildi",
                    text: "Kayıt güvende.",
                    confirmButtonColor: "#2196F3",
                    type: "error"
                });
            }
        });
    }
</script>