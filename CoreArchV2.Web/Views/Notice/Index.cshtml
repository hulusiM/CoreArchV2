@using CoreArchV2.Core.Enum.NoticeVehicle.Notice
<script>$('#broadCrumbDiv').text('Talep Yönetimi / İhbar Tanımları')</script>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="breadcrumb-line breadcrumb-line-component content-group-lg bg-teal-400" style="margin: 3px -11px 0 -23px;">
    <ul class="breadcrumb">
        <li>İhbar Tanımları</li>
    </ul>

    <ul class="breadcrumb-elements">
        <li>
            <a onclick="excelModalOpen()"><i class="icon-file-excel position-left"></i> Excel'den Aktar</a>
        </li>
        <li>
            <a onclick="newNotice()"><i class="icon-make-group position-left"></i> Yeni Kayıt</a>
        </li>
        <li class="dropdown">
            <a href="#" id="btnSearch" class="dropdown-toggle" data-toggle="dropdown" onclick="funcSearchForm()">
                <i class="icon-gear position-left"></i>
                Filtreleme Seçenekleri
                <span class="caret"></span>
            </a>
            <ul id="FormSearchTable" class="dropdown-menu dropdown-menu-right">
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <label>İhbar Tipi :</label>
                        <select id="comboBox-NoticeTypeId-search"
                                class="select-search"
                                tabindex="1"
                                table-param="NoticeTypeId"
                                table-id="comboBox-NoticeTypeId-search"
                                table-model-url="/Combo/GetNoticeType"
                                table-tool-type="comboBox"
                                table-description="İhbar Tipi"
                                data-option-label="İhbar Tipi Seçiniz">
                        </select>
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <select id="select-userId"
                                tabindex="4"
                                table-param="Id"
                                class="select2-container select2-selection--single">
                        </select>
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <label>İşlem Tarihi (Hız İhlali)</label>
                        <input table-param="TransactionDate" tabindex="5" class="form-control" type="date">
                    </div>
                </li>
                <li>
                    <div class="col-md-6" style="margin-top: 8px;">
                        <label>Baş.Tarihi</label>
                        <input id="StartDate" table-param="StartDate" tabindex="2" class="form-control" type="date" autocomplete="off">
                    </div>
                    <div class="col-md-6" style="margin-top: 8px;">
                        <label>Bit.Tarihi</label>
                        <input id="EndDate" table-param="EndDate" tabindex="3" class="form-control" type="date" autocomplete="off">
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin-top: 8px;">
                        <button type="button" style="width: 100%;" class="btn bg-danger-800 btn-xs" onclick="funcClearFilterTable('FormSearchTable')"><i class="icon-trash"></i> Temizle</button>
                    </div>
                </li>
                <li>
                    <div class="col-md-12" style="margin: 8px 0 8px 0;">
                        <button type="button" style="float: left; width: 100%;" class="btn bg-teal-300 btn-xs" onclick="funcFilterTable()"><i class="icon-search4"></i> Filtrele</button>
                    </div>
                </li>
            </ul>
        </li>
    </ul>
</div>

<div class="content has-bg-image small" style="margin: -25px -10px 0px -23px;">
    <div class="panel panel-flat has-bg-image">
        <div class="panel-body ">
            <div class="row">
                <div class="table-responsive genericDatatables">
                    <table class="table-striped table-hover table-bordered table datatable-basic table-loader"
                           id="dataTableNotice"
                           table-id="dataTable-Notice"
                           table-model-url="/Notice/NoticeGetAll"
                           table-DatabaseName="/Notice"
                           table-tool-type="dataTable">
                        <thead>
                            <tr class="filters">
                                <th data-value="Id" hidden="hidden"></th>
                                <th style="text-align: center; width: 1%;">No</th>
                                <th data-value="Plate" style="text-align: center;">
                                    Plaka
                                </th>
                                <th data-value="TransactionDate" data-type="datetime" style="text-align: center;">
                                    İşlem Tarihi
                                </th>
                                <th data-value="FirstRunEngineDate" data-type="datetime" style="text-align: center;">
                                    Motor Açılış
                                </th>
                                <th data-value="LastRunEngineDate" data-type="datetime" style="text-align: center;">
                                    Motor Kapanış
                                </th>
                                <th data-value="NoticeTypeName" style="text-align: center;">
                                    İhbar Tipi
                                </th>
                                <th data-value="StateName" style="text-align: center;">
                                    Durum
                                </th>
                                <th data-value="ButtonEditDelete" style="text-align: center;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="table-footer">
                    <div class="col-md-12" id="TableFooter">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="EditInsertModal" class="modal fade" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-orange">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h6 class="modal-title">İhbar Bilgileri</h6>
            </div>
            <div class="modal-body">
                <div id="Notice_FormId">
                    <input type="text" table-param="Id" hidden />
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-6">
                                <label>İhbar Tipi (*) :</label>
                                <div style="border: 1px solid red;border-radius: 3px;margin: -1px;">
                                    <select id="comboBox-NoticeTypeId2"
                                            class="select-search"
                                            tabindex="1"
                                            table-param="NoticeType"
                                            onchange="ChangeNoticeOpenDiv()"
                                            table-id="comboBox-NoticeTypeId2"
                                            table-model-url="/Combo/GetNoticeType"
                                            table-tool-type="comboBox"
                                            table-description="İhbar Tipi"
                                            data-option-label="İhbar Tipi Seçiniz" required>
                                    </select>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <label>Araç Plaka (*) :</label>
                                <div style="border: 1px solid red;border-radius: 3px;margin: -1px;">
                                    <select id="select-vehicleId2"
                                            style="border:1px solid red"
                                            tabindex="2"
                                            onchange="getNoticeRangeUser()"
                                            table-param="VehicleId"
                                            table-description="Araç"
                                            class="select2-container select2-selection--single" required>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Arvento No :</label>
                                <input table-param="ArventoNo" autocomplete="off" tabindex="3"
                                       style="border:1px solid red" type="text" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Sürücü (Adı ve Soyadı):</label>
                                <input table-param="Driver" autocomplete="off" tabindex="4"
                                       style="border:1px solid red" type="text" class="form-control" placeholder="Araç Sürücüsü">
                            </div>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Hız Limit Aşımı :</legend>
                        <div id="speedDiv" class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>İşlem Tarihi :</label>
                                    <input id="transactionDate" onchange="getNoticeRangeUser()" table-param="TransactionDateSpeed" autocomplete="off" tabindex="3" type="date" class="form-control" disabled />
                                </div>
                                <div class="col-md-4">
                                    <label>Araç Hızı (Kmh):</label>
                                    <input autocomplete="off" tabindex="3" type="text" min="0" table-param="Speed" class="form-control moneyCurrency" placeholder="Araç Hızı" disabled />
                                </div>
                                <div class="col-md-4">
                                    <label>Adres :</label>
                                    <input table-param="Address" autocomplete="off" tabindex="3" type="text" class="form-control" disabled />
                                </div>
                            </div>
                        </div>
                    </fieldset>
                  @*  <fieldset>
                        <legend>Mesai Dışı Kullanım :</legend>
                        <div id="outOfHourDiv" class="form-group">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>İşlem Baş.Tarihi :</label>
                                    <input table-param="FirstRunEngineDate" autocomplete="off" tabindex="3" type="datetime-local" class="form-control" disabled />
                                </div>
                                <div class="col-md-4">
                                    <label>İşlem Bit.Tarihi :</label>
                                    <input table-param="LastRunEngineDate" autocomplete="off" tabindex="3" type="datetime-local" class="form-control" disabled />
                                </div>
                                <div class="col-md-4">
                                    <label>Toplam Km :</label>
                                    <input table-param="TotalKm" autocomplete="off" tabindex="3" type="text" class="form-control moneyCurrency" disabled />
                                </div>
                            </div>
                        </div>
                    </fieldset>*@
                    <fieldset>
                        <legend>Görev Analizi :</legend>
                        <div id="dutyDiv" class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>İşlem Tarihi :</label>
                                    <input table-param="TransactionDateMission" autocomplete="off" tabindex="3" type="date" class="form-control" disabled />
                                </div>
                                <div class="col-md-3">
                                    <label>Görev Adı :</label>
                                    <input table-param="MissionName" autocomplete="off" tabindex="3" type="text" class="form-control" disabled />
                                </div>
                                <div class="col-md-3">
                                    <label>Görev Bölgesi :</label>
                                    <select id="CityId"
                                            tabindex="5"
                                            class="select-search"
                                            table-param="CityId"
                                            table-id="comboBox-CityId"
                                            table-model-url="/Combo/GetCityAndDistrictCmbx"
                                            table-tool-type="comboBox"
                                            table-description="Şehir/Bölge"
                                            data-option-label="Şehir/Bölge Seçiniz">
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label>Görev Adresi :</label>
                                    <input table-param="Address" autocomplete="off" tabindex="3" type="text" class="form-control" disabled />
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-12">
                                <label class="control-label">Değerlendirme Notu:</label>
                                <textarea rows="3" cols="5" table-param="Description" tabindex="13" class="form-control" placeholder="Değerlendirme Notu" style="border: 1px solid red"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="col-sm-4 col-md-6">
                </div>
                <div class="col-sm-4 col-md-3">
                    <button type="button" tabindex="16" class="btn btn-danger full-width" onclick="funcCancelModal('#Notice_FormId [table-param]')"><i class="fa fa-times"></i> İptal</button>
                </div>

                <div class="col-sm-4 col-md-3">
                    <button tabindex="15" type="submit" class="btn btn-primary full-width" onclick="funcSaveNotice()"><i class="fa fa-check"></i> Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ImportExcelModal" class="modal fade" data-backdrop="static">
    <div class="modal-dialog modal-full">
        <div class="modal-content">
            <div class="modal-header bg-orange">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h6 class="modal-title">Excel'den İhlal Ekle</h6>
            </div>
            <div class="modal-body">
                <div id="ImportNoticeExcel_FormId">
                    <div class="form-group">
                        <div class="row">
                            <div id="PublishExcelNotice_FormId" class="form-group">
                                <div class="row">
                                    <div class="col-md-5">
                                        <label>İhbar Tipi (*) :</label>
                                        <select id="comboBox-NoticeTypeId3"
                                                class="select-search"
                                                tabindex="1"
                                                table-param="NoticeType"
                                                table-id="comboBox-NoticeTypeId3"
                                                onchange="ChangeNoticeType()"
                                                table-model-url="/Combo/GetNoticeType"
                                                table-tool-type="comboBox"
                                                table-description="İhbar Tipi"
                                                data-option-label="İhbar Tipi Seçiniz" required>
                                        </select>
                                    </div>

                                    <div class="col-md-5">
                                        <label>Excel Dosya :</label>
                                        <input type="file" id="noticeExcelfileupload" class="form-control" />
                                    </div>

                                    <div class="col-md-2">
                                        <label>-</label>
                                        <input type="button" value="Ön İzleme" id="uploadExcelPreview" class="btn btn-success full-width" />
                                    </div>
                                </div>
                            </div>
                            <div id="noticeTypeBody" class="form-group">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <style>
                #excelPrew_true tr {
                    text-align: center;
                }

                #excelPrew_false tr {
                    text-align: center;
                }
            </style>
            <div style="margin-top: -25px;" class="modal-footer">
                <div class="form-group">
                    <div class="col-md-6"></div>
                    <div class="col-md-2">
                        <button type="button" tabindex="16" class="btn btn-warning full-width" onclick="removeText()"><i class="fa fa-times"></i> Ekranı Temizle</button>
                    </div>
                    <div class="col-md-2">
                        <button type="button" tabindex="16" class="btn btn-danger full-width" onclick="funcCancelModal('#ImportNoticeExcel_FormId [table-param]')"><i class="fa fa-times"></i> İptal</button>
                    </div>
                    <div class="col-md-2">
                        <button tabindex="15" type="submit" class="btn btn-primary full-width" onclick="insertFromNoticeExcelData()"><i class="fa fa-check"></i> Sisteme Aktar</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


@* <script src="~/admin/select2/select2.min.js"></script> *@
<script type="text/javascript">
    $('#select-userId').select2({
        placeholder: 'Adı,Soyadı veya Telefon Numarası',
        minimumInputLength: 3,
        ajax: {
            url: '/Combo/GetUserCmbx',
            dataType: 'json',
            delay: 250,
            processResults: function(data) {
                return {
                    results: data
                };
            },
            cache: true
        }
    });
    $('#select-vehicleId2').select2({
        placeholder: 'Araç Seçiniz',
        minimumInputLength: 3,
        language: "tr",
        ajax: {
            url: '/Combo/GetVehicleCmbx?isActive=true',
            dataType: 'json',
            delay: 250,
            processResults: function (data) {
                return {
                    results: data
                };
            },cache: true
        }
    });
</script>

<script>
    function newNotice(type = 0) {
        FormAllInputsClear('#Notice_FormId [table-param]');
        $('#EditInsertModal').modal("show");
        if (type > 0)
            $('#comboBox-NoticeTypeId2').val(type).change();
        //else
        //    $("#comboBox-NoticeTypeId2").select2("open");
    }

    function funcSaveNotice() {
        var model = FormGetAllValue("#Notice_FormId [table-param]");
        if (model != null) {
            sendAjxForm(model, "/Notice/InsertUpdateNotice",
                function (e) {
                    if (e.IsSuccess == true) {
                        funcFilterTable();
                        ShowMessage("success", "Bilgi", "İşlem Başarılı.");
                        $('#EditInsertModal').modal("hide");
                    }
                    else if (e.IsSuccess == false)
                        ShowMessage("error", "Hata", e.Message);
                }, 'POST');
        }
    }

    function getNoticeRangeUser(){
        var vehicleId = $('#select-vehicleId2').val();
        var transactionDate =  $('#transactionDate').val();
        if(vehicleId > 0 && transactionDate != ''){
            sendAjxForm({ TransactionDate: transactionDate, VehicleId: vehicleId },
                "/Utility/FindDateRangeDebitUser",
                function (e) {
                    if (e != null)
                        ShowMessage("info", "Bilgi", ("Araç seçilen tarihte <b>" + e.FullName + "</b> adlı kişide görünüyor"));
                    else
                        ShowMessage("info", "Bilgi", "Seçilen tarihte araç zimmeti bulunamadı");
                }, "GET");
        }
    }

    function funcEditNotice(noticeId) {
        sendAjxForm({ Id: noticeId },"/Notice/GetByIdNotice",function(e) {
            if (e != null) {
                var model = {
                    selector: '#Notice_FormId [table-param]',
                    data: e
                };
                FormSetAllValue(model);
                setVehicle(e.VehicleId, "select-vehicleId2");
                $('#EditInsertModal').modal("show");
            } else
                ShowMessage("error", "Hata", "Hata oluştu!");
        },'GET');
    }

    //------------------------------------- Static Area Start ---------------------------------------//
    function funcFilterTable(incomingUrl) {
        firstLoadModal = true;
        if (incomingUrl == undefined || incomingUrl == null || incomingUrl == "")
            incomingUrl = "/Notice/NoticeGetAll";

        var model = FormGetAllValue("#FormSearchTable [table-param]");

        dtSayac = 0;
        sendAjxForm(model, incomingUrl, funcDataTable, "POST");

        IsSearchOpen = false;
        $('#FormSearchTable').hide();
    }

    function funcClearFilterTable() {
        FormAllInputsClear('#FormSearchTable [table-param]');
        funcFilterTable();
        ShowMessage("success", "Bilgi", "Tüm parametreler temizlendi.");
    }
    //------------------------------------- Static Area End ---------------------------------------//
</script>


<script>
    var previewButtonClick = false;
    function excelModalOpen() {
        excelModalClear();
        setTimeout(function () {$('#comboBox-NoticeTypeId3').val(1).change(); }, 300);
        $('#ImportExcelModal').modal('show');
    }

    function ChangeNoticeOpenDiv() {
        $("#speedDiv input").prop('disabled', true);
        $("#dutyDiv input").prop('disabled', true);
        $("#outOfHourDiv input").prop('disabled', true);
        $("#speedDiv").slideUp("slow");
        $("#dutyDiv").slideUp("slow");
        $("#outOfHourDiv").slideUp("slow");

        var type = $('#comboBox-NoticeTypeId2').val();
        if (type == @((int)NoticeType.Speed)) {
            $("#speedDiv").slideDown("slow");
            $("#speedDiv input").prop('disabled', false);
        }else if (type == @((int)NoticeType.OutOfHours)) {
            $("#outOfHourDiv").slideDown("slow");
            $("#outOfHourDiv input").prop('disabled', false);
        }else if (type == @((int)NoticeType.Duty)) {
            $("#dutyDiv").slideDown("slow");
            $("#dutyDiv input").prop('disabled', false);
        }
    }

    function ChangeNoticeType() {
        $('#noticeTypeBody').empty();
        var type = $('#comboBox-NoticeTypeId3').val();
        if (type == @((int)NoticeType.Duty)) {
            ShowMessage("warning", "Bilgi", "Bu ihbar türü excel ile eklenemez.<br/>Tekil eklemek için <a onclick='newNotice(@((int)NoticeType.Duty))' style='color:blue;'>Tıklayınız</a>",20000);
        } else if (type > 0)
            $('#noticeTypeBody').load('@Url.Action("ChangePartialBulkExcel","Notice")?type=' + type);
    }

    function excelModalClear() {
        FormAllInputsClearNoCloseModal("#PublishExcelNotice_FormId [table-param]");
        $("#noticeExcelfileupload").val('');
        removeText();
    }

    function insertFromNoticeExcelData() {
        if (!previewButtonClick) {
            ShowMessage("info", "Bilgi", "Excel seçtikten sonra ön izleme butonuna basıp kontrol ettikten sonra sisteme aktarabilirsiniz");
            return;
        }

        var model = FormGetAllValue("#PublishExcelNotice_FormId [table-param]");
        if (model != null) {
            $('#loadingEffect').css("display", "flex");
            setTimeout(function () {
                var fileUpload = $("#noticeExcelfileupload").get(0);
                var files = fileUpload.files;
                var fdata = new FormData();
                fdata.append(files[0].name, files[0]);
                fdata.append("noticeType", parseInt(model.NoticeType));
                sendAjxFormFileUpload(fdata, "/Notice/ReadExcelForInsertNotice",
                    function (e) {
                        if (e == 'NotAuthorizationCore')
                            ShowMessage("warning", "Bilgi", "Bu işlemi yapmaya yetkiniz bulunmamaktadır");
                        else if (e.IsSuccess) {
                            funcFilterTable();
                            excelModalClear();
                            $('#ImportExcelModal').modal('hide');
                            ShowMessage("success", "Bilgi", "Kayıt başarılı");
                        }
                        else
                            ShowMessage("warning", "Bilgi", e.Message);
                    }, "POST");
                $('#loadingEffect').css("display", "none");
            }, 50);
        }
    }

    $("#uploadExcelPreview").click(function () {
        previewButtonClick = true;
        dataFillExcel();
    });

    $("#noticeExcelfileupload").on('change', function () {
        previewButtonClick = false;
        removeText();
    });

    function removeText() {
        $('#excelPrew_true tr').remove();
        $('#excelPrew_false tr').remove();
        $('#span_true').html("0");
        $('#span_false').html("0");
    }

    function dataFillExcel() {
        removeText();
        var noticeType = $('#comboBox-NoticeTypeId3').val();
        if (noticeType == '') {
            ShowMessage("warning", "Bilgi", "İhbar Tipi Seçiniz");
            return;
        }

        var fileUpload = $("#noticeExcelfileupload").get(0);
        var files = fileUpload.files;
        if (files.length > 0) {
            $('#loadingEffect').css("display", "flex");
            setTimeout(function () {
                var fdata = new FormData();
                fdata.append(files[0].name, files[0]);
                fdata.append("noticeType", noticeType);
                sendAjxFormFileUpload(fdata, "/Notice/ReadExcelForNotice",
                    function (response) {
                        if (response == 'NotAuthorizationCore')
                            ShowMessage("info", "Bilgi", "Bu işlemi yapmaya yetkiniz bulunmamaktadır");
                        else if (response.HtmlString != "" && response.HtmlString != null) {
                            //Sistemde olan plakalar
                            $('#excelPrew_true').html(response.HtmlString[0]);
                            setTimeout(function () {
                                $('#span_true').html($('#excelPrew_true tr').length);
                            }, 500);
                            //Sistemde olmayan plakalar
                            $('#excelPrew_false').html(response.HtmlString[1]);
                            setTimeout(function () {
                                var notFoundPlate = $('#excelPrew_false tr').length;
                                if (notFoundPlate > 0)
                                    ShowMessage("warning", "Bilgi", ("Sistemde bulunmayan <b>" + notFoundPlate + "</b> adet plaka bulundu!"), 10000);
                                $('#span_false').html(notFoundPlate);
                            }, 500);
                        }
                        else
                            ShowMessage("warning", "Hatalı Excel Format", "Ekrandaki sıralamaya göre excel formatı hazırlayıp tekrar deneyiniz", 20000);

                        $('#loadingEffect').css("display", "none");
                    }, 'POST', function (err) {
                        ShowMessage("warning", "Hatalı Excel Format", "Ekrandaki sıralamaya göre excel formatı hazırlayıp tekrar deneyiniz", 20000);
                        $('#loadingEffect').css("display", "none");
                    });
            }, 50);
        } else
            ShowMessage("warning", "Bilgi", "Excel dosyası seçiniz");
    }

</script>