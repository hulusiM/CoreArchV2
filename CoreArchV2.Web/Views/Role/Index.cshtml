<script>$('#broadCrumbDiv').text('Sistem Yönetimi / Rol Tanımları')</script>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/admin/jstree/style.min.css" rel="stylesheet" />
<script src="~/admin/jstree/jstree.min.js"></script>

<div class="breadcrumb-line breadcrumb-line-component content-group-lg bg-teal-400" style="margin: 3px -11px 0 -23px;">
    <ul class="breadcrumb">
        <li>Rol Tanımları</li>
    </ul>

    <ul class="breadcrumb-elements">
        <li>
            <a onclick="funcAllAuthRoleModal()"><i class="icon-make-group position-left"></i> Yeni Kayıt</a>
        </li>
    </ul>
</div>

<div class="content has-bg-image small" style="margin: -25px -10px 0px -23px;">
    <div class="panel panel-flat has-bg-image">
        <div class="panel-body ">
            <div class="row">
                <div class="table-responsive genericDatatables">
                    <table class="table-striped table-hover table-bordered table datatable-basic table-loader"
                           id="dataTableRole"
                           table-id="dataTable-Role"
                           table-model-url="/Role/RoleGetAll"
                           table-DatabaseName="/Role"
                           table-tool-type="dataTable">
                        <thead>
                            <tr class="filters ">
                                <th data-value="ID" hidden="hidden"></th>
                                <th style="text-align: center; width: 1%;">No</th>
                                <th data-value="Name" style="text-align: center;">
                                    Yetki Adı
                                </th>

                                <th data-value="ButtonEditDelete" style="text-align: center;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="table-footer">
                    <div class="col-md-12" id="TableFooter">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="EditInsertModal" class="modal fade" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success-300">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 id="ModalTitleId" class="modal-title"> Rol Ekle/Düzenle Sayfası</h5>
            </div>
            <div class="modal-body">
                <div class="horizontal-form">
                    <div id="Role_FormId" class="form-body">
                        <input type="text" table-param="Id" hidden />
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-12">
                                    <label>Rol Adı (*) :</label>
                                    <input type="text" id="RoleName" autocomplete="off" table-param="Name" class="form-control" placeholder="Rol adı giriniz">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div id="jsTreeDiv" class="form-group" style="margin-left: 9px; margin-right: 10px; margin-top: 15px;">
                                    <div id="data">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-sm-4 col-md-6">
                </div>
                <div class="col-sm-4 col-md-6">
                    <button type="button" class="btn btn-danger" onclick="funcCancelModal('#Role_FormId [table-param]')"><i class="fa fa-times"></i> İptal</button>
                    <button id="" type="submit" class="btn btn-primary" onclick="funcSaveRole()"><i class="fa fa-check"></i> Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var url = "";
    var roleIdd = 0;

    function funcSaveRole() {
        var roleName = $('#RoleName').val();
        var selectedElementId = $('#data').jstree("get_selected");

        //var selectedElmsIds = [];
        //var parent = [];
        //var selectedElms = $('#data').jstree("get_selected", true);
        //$.each(selectedElms, function () {
        //    selectedElmsIds.push(this.text);
        //    parent.push(this.parent);
        //});

        if (roleName.length > 0) {
            if (selectedElementId.length > 0) {
                var model = {
                    ID: roleIdd,
                    RoleName: roleName,
                    AuthorizationIdList: selectedElementId.map(Number)
                };

                sendAjxForm(model,
                    url,
                    function (e) {
                        if (e === true) {
                            FormAllInputsClear('#Role_FormId [table-param]');
                            ShowMessage("success", "Uyarı", "Kayıt Başarılı");
                        } else if (e === false)
                            ShowMessage("error", "Uyarı", "Kayıt sırasında hata oluştu");
                        else
                            ShowMessage("warning", "Bilgi", e);
                    },
                    'POST');

            } else
                ShowMessage("warning", "Uyarı", "En az 1 adet rol seçiniz.");
        } else
            ShowMessage("warning", "Uyarı", "Role Adı Boş geçilemez.");
    }

    // jstree load
    function funcAllAuthRoleModal() {
        $('#data').remove();
        $('#jsTreeDiv').append('<div id="data"></div>');
        $('#data').jstree({
            'core': {
                "multiple": true,
                "themes": {
                    "theme": "classic",
                    "dots": true,
                    "variant": "small",
                    "icons": true
                },
                'data': {
                    "url": "/Role/GetAllMenuList",
                    "data": function (node) {
                        return { "id": node.id };
                    }
                }
            },
            "checkbox": {
                "keep_selected_style": false
            },
            "plugins": ["wholerow", "checkbox"]
        });

        url = "/Role/Insert";
        $('#EditInsertModal').modal("show");
    }

    function funcEditRole(roleId) {
        roleIdd = roleId;
        var model = { Id: roleId };
        var urlGetById = "/Role/GetById";

        sendAjxForm(model,
            urlGetById,
            function (e) {
                if (e.length > 0) {
                    $('#data').remove();
                    $('#jsTreeDiv').append('<div id="data"></div>');

                    $('#data').jstree({
                        'core': {
                            "multiple": true,
                            "themes": {
                                "theme": "classic",
                                "dots": true,
                                "variant": "small",
                                "icons": true
                            },
                            'data': e
                        },
                        "checkbox": {
                            "keep_selected_style": false
                        },
                        "plugins": ["wholerow", "checkbox"]
                    });

                    if (e.length > 0)
                        $('#RoleName').val(e[0].RoleName);

                    url = "/Role/Update";
                    $('#EditInsertModal').modal("show");
                } else {
                    ShowMessage("error", "Hata", "Düzenleme esnasında hata oluştu!");
                }
            },
            'POST');
    }

    function funcFilterTable() {
        sendAjxForm("", "/Role/RoleGetAll", funcDataTable, "POST");
    }
</script>